{% from 'bootstrap/utils.html' import icon %}

{% macro snapshot_annotator() %}
    {# Include jquery.snapshot-annotator.js and holder.min.js to use this #}
    {% set modal_id = 'snapshot-annotator-modal' %}
    {% set annotator_id = modal_id + '-annotator' %}
    {% set timestamp_id = modal_id + '-timestamp' %}
    {% set detections_in_roi_count_id = modal_id + '-detetion-in-roi-count' %}
    {% set filtered_detections_count_id = modal_id + '-filtered-detections-count' %}
    {% set detection_help_id = modal_id + '-detection-help' %}
    {% set detection_info_id = modal_id + '-detection-info' %}
    {% set detection_confidence_id = modal_id + '-detection-confidence' %}
    {% set detection_filtered_status_id = modal_id + '-detection-filtered-status' %}
    {% set detection_similar_id_id = modal_id + '-detection-similiar-id' %}
    {% set detection_similar_score_id = modal_id + '-detection-similar-score' %}
    {% set detection_mark_as_fp_id = modal_id + '-detection-mark-as-fp' %}
    {% set detection_mark_as_fp_form_id = modal_id + '-detection-mark-as-fp-form' %}

    {% from '_helpers.html' import render_modal %}
    {# TODO: add hashes for snapshots to make links for them #}
    {% call render_modal(modal_id, classes='modal-lg') %}
        <div class="modal-body">
            <div class="row">
                <div class="col-lg-12" id="{{ annotator_id }}"></div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <h4 class="text-center">Recognition</h4>
                    <ul class="list-group">
                        <li class="list-group-item">
                            {{ icon('calendar') }}
                            Snapshot received
                            <span class="badge" id="{{ timestamp_id }}"></span>
                        </li>
                        <li class="list-group-item">
                            {{ icon('user') }}
                            Queue size
                            <span class="badge" id="{{ detections_in_roi_count_id }}"></span>
                        </li>
                        <li class="list-group-item">
                            {{ icon('filter') }}
                            Filtered detections
                            <span class="badge" id="{{ filtered_detections_count_id }}"></span>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-6">
                    <h4 class="text-center">Detection</h4>
                    <div class="text-center" id="{{ detection_help_id }}">
                        Click on detection to show more info
                    </div>
                    <ul class="list-group hide" id="{{ detection_info_id }}">
                        <li class="list-group-item">
                            {{ icon('signal') }}
                            Confidence
                            <span class="badge" id="{{ detection_confidence_id }}"></span>
                        </li>
                        <li class="list-group-item">
                            {{ icon('filter') }}
                            Filtered reason
                            <span class="badge" id="{{ detection_filtered_status_id }}"></span>
                        </li>
                        {% if current_user.has_role('admin') %}
                            <li class="list-group-item list-group-item-info">
                                SSD with similar detection
                                <span class="badge" id="{{ detection_similar_id_id }}"></span>
                            </li>
                            <li class="list-group-item list-group-item-info">
                                Similar detection ID
                                <span class="badge" id="{{ detection_similar_score_id }}"></span>
                            </li>
                        {% endif %}
                        <li class="list-group-item text-center">
                            <form hidden id="{{ detection_mark_as_fp_form_id }}"
                                  action="{{ url_for('detection_marked_by_user_as_false_positive_set', id=0) }}">
                                {% for field in detection_marked_by_user_as_false_positive_form %}
                                    {{ field }}
                                {% endfor%}
                            </form>
                            <button type="button" class="btn" id="{{ detection_mark_as_fp_id }}"
                                    data-loading-text="Sending data...">
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    {% endcall %}

    <script type="text/javascript">
        function updateRecognitionViewer(element) {
            var $element, recognitionJson, $annotator, imageWidth, imageHeight, buffer, figures, shadingPolygon,
                    options, imageUrlTemplate;

            $element = $(element);
            recognitionJson = JSON.parse(element.dataset.recognitionJson);
            $annotator = $('#{{ annotator_id }}');
            imageWidth = parseInt(recognitionJson.snapshot_width);
            imageHeight = parseInt(recognitionJson.snapshot_height);

            function detectionsPassedFiltersCount() {
                var result = 0;
                recognitionJson.detections.forEach(function (det) {
                    if (det.filtered_status === 'FilteredReason.passed_filters') {
                        result++;
                    }
                });
                return result
            }

            function determineColor(detection) {
                // Returns color for specific detection
                if (detection.filtered_status !== 'FilteredReason.passed_filters') {
                    return 'rgb(217, 6, 0)';
                } else if (detection.marked_by_user_as_false_positive) {
                    return 'rgb(248, 160, 0)'
                }
                return 'rgb(0, 184, 0)';
            }

            function buildFigures() {
                // Parses JSON
                var figures, det, i, l, t, w, h, color;

                figures = [];

                function make_point_ar(p) { return {x: p[0], y: p[1]} }

                function make_point(x, y) { return {x: x, y: y} }

                for (i = 0; i < recognitionJson.detections.length; i += 1) {
                    det = recognitionJson.detections[i];
                    l = det.bbox[0];
                    t = det.bbox[1];
                    w = det.bbox[2];
                    h = det.bbox[3];
                    color = determineColor(det);
                    figures.push({
                        name: det.confidence.toFixed(2),
                        points: [
                            make_point(l, t),
                            make_point(l + w - 1, t),
                            make_point(l + w - 1, t + h - 1),
                            make_point(l, t + h - 1)
                        ],
                        color: color
                    })
                }

                return [figures, recognitionJson.filters.roi_polygon && recognitionJson.filters.roi_polygon.map(make_point_ar)]
            }

            function renderMarkAsFpButtonText() {
                var $button = $('#{{ detection_mark_as_fp_id }}');

                if (element.dataset.allowMarkAsFp === 'true') {
                    $button.parent().show();
                    if ($button.hasClass('active')) {
                        $button.removeClass('btn-warning');
                        $button.addClass('btn-success');
                        $button.html(
                                '{{ icon('ok') }} Unmark false positive'
                        )
                    } else {
                        $button.addClass('btn-warning');
                        $button.removeClass('btn-success');
                        $button.html(
                                '{{ icon('remove') }} Mark as false positive'
                        )
                    }
                } else {
                    $button.parent().hide()
                }
            }

            /////////////////// Parse figures
            buffer = buildFigures();
            figures = buffer[0];
            shadingPolygon = buffer[1];

            /////////////////// Setup default options
            options = {
                readOnly: true,
                figures: figures,
                autoSelectFirst: false,
                shadingPolygon: shadingPolygon,
                onSelectionChanged: function (figureId) {
                    {# TODO: i18n Extract this to python part to use i18n features #}
                    var det, filteredStatusMessages = {
                        'FilteredReason.passed_filters': 'Not filtered',
                        'FilteredReason.min_head_size': 'Smaller that minimal head size',
                        'FilteredReason.max_head_size': 'Larger that maximal head size',
                        'FilteredReason.outside_roi': 'Outside of ROI',
                        'FilteredReason.similar_with_marked_as_fp': 'Were marked as FP on previous frames'
                    };
                    if (figureId === null) {
                        $('#{{ detection_info_id }}').addClass('hide');
                        $('#{{ detection_help_id }}').removeClass('hide');
                    } else {
                        det = recognitionJson.detections[figureId];
                        $('#{{ detection_mark_as_fp_id }}').toggleClass(
                                'active',
                                det.marked_by_user_as_false_positive
                        );
                        $('#{{ detection_info_id }}').removeClass('hide');
                        $('#{{ detection_help_id }}').addClass('hide');
                        $('#{{ detection_confidence_id }}').html(
                                det.confidence.toFixed(2)
                        );
                        $('#{{ detection_filtered_status_id }}').html(
                                filteredStatusMessages[det.filtered_status]
                        );
                        {% if current_user.has_role('admin') %}
                            $('#{{ detection_similar_score_id }}').html(
                                    det.similar_marked_as_fp_detection_score
                            );
                            $('#{{ detection_similar_id_id }}').html(
                                    det.similar_marked_as_fp_detection_id
                            );
                        {% endif %}
                        renderMarkAsFpButtonText();
                    }
                }
            };

            /////////////////// Setup annotator
            imageUrlTemplate = '{{ url_for('snapshot', id='1', width='2', height='3') }}'
                    .replace('1', '<id>').replace('2', '<width>').replace('3', '<height>')
                    .replace('<id>', recognitionJson.snapshot_id);

            if (recognitionJson.snapshot_id !== null) {
                $element.annotator($.extend({}, options, {
                    imageUrl: imageUrlTemplate
                            .replace('<width>', '' + element.dataset.previewWidth)
                            .replace('<height>', '0'),
                    overrideImageWidth: recognitionJson.snapshot_width,
                    overrideImageHeight: recognitionJson.snapshot_height,
                    allowSelectionWithClick: false
                }));

                //noinspection JSValidateTypes
                $($element.children()[0]).addClass('img-rounded').addClass('modal-trigger');

                if (element.dataset.toggleModal === 'on') {
                    $element.click(function () { // Setup popup
                        var $detection_mark_as_fp_button = $('#{{ detection_mark_as_fp_id }}');
                        $annotator.annotator($.extend({}, options, {
                            imageUrl: imageUrlTemplate.replace('<width>', '0').replace('<height>', '0')
                        }));
                        $('#{{ timestamp_id }}').html(
                                moment.unix(recognitionJson.server_timestamp).format('L LTS')
                        );
                        $('#{{ detections_in_roi_count_id }}').html(
                                detectionsPassedFiltersCount()
                        );
                        $('#{{ filtered_detections_count_id }}').html(
                                recognitionJson.detections.length - detectionsPassedFiltersCount()
                        );
                        $('#{{ modal_id }}').modal('show');

                        if (element.dataset.allowMarkAsFp !== 'true') {
                            return;
                        }

                        $detection_mark_as_fp_button.off('click'); // Remove previous callbacks
                        $detection_mark_as_fp_button.click(function () { // Setup new callback
                            var activeFigure = $annotator.data('annotator').activeFigure,
                                    det = recognitionJson.detections[activeFigure],
                                    det_id = det.id,
                                    $form = $('#{{ detection_mark_as_fp_form_id }}'),
                                    $target_field = $form.find('[name="marked_by_user_as_false_positive"]');

                            function updateAnnotators() {
                                det.marked_by_user_as_false_positive = $detection_mark_as_fp_button.hasClass('active');
                                $target_field.prop('checked', det.marked_by_user_as_false_positive);

                                figures[activeFigure].color = determineColor(det);
                                renderMarkAsFpButtonText();
                                $annotator.data('annotator').redraw();
                                $element.data('annotator').redraw();
                            }

                            $(this).button('loading');
                            $(this).toggleClass('active');
                            updateAnnotators();

                            $.ajax({
                                url: $form.prop('action').replace('/0', '/' + det_id),
                                type: 'POST',
                                dataType: 'json',
                                data: $form.serialize(),
                                error: function () {
                                    $detection_mark_as_fp_button.toggleClass('active');
                                    updateAnnotators();
                                    {# FIXME: replace alert with bootstrap alert #}
                                    alert('Error communicating with server... Check you internet connection')
                                },
                                complete: function () {
                                    $detection_mark_as_fp_button.button('reset');
                                }
                            });
                        });
                    });
                }
            }

            /////////////////// Setup placeholder
            if (recognitionJson.snapshot_id === null) {
                var viewportWidth, viewportHeight;
                viewportWidth = element.clientWidth;
                viewportHeight = imageHeight * (viewportWidth / imageWidth);
                Holder.addImage(
                        'holder.js/' + viewportWidth + 'x' + viewportHeight +
                        '?theme=gray&text=Snapshot removed',
                        element
                ).run();
                //noinspection JSValidateTypes
                $($element.children()[0]).addClass('img-rounded');
            }

            /////////////////// Resize elements with windows
            $(window).resize(function () {
                var viewportWidth, viewportHeight, placeholderStyle;
                viewportWidth = element.clientWidth;
                viewportHeight = imageHeight * (viewportWidth / imageWidth);

                if (recognitionJson.snapshot_id === null) {
                    // Show placeholder
                    placeholderStyle = $element.find('img')[0].style;
                    placeholderStyle.width = viewportWidth + 'px';
                    placeholderStyle.height = viewportHeight + 'px';
                    return;
                }

                $element.data('annotator').redraw();
            });

            /////////////////// Run resize explicitly once
            $(window).resize();
        }

        $(document).ready(function () {
            $('#{{ modal_id }}').on('shown.bs.modal', function () {
                $('#{{ annotator_id }}').data('annotator').redraw();
            }).on('hidden.bs.modal', function () {
                $('#{{ annotator_id }}').data('annotator').destroy();
            });

            $('.recognition-viewer').each( function(index, element) {
                updateRecognitionViewer(element);
            });
        });
    </script>
{%- endmacro %}
